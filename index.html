<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>
  <style>
    body {
      margin: 0;
      background-color: #0d1117;
      color: #c9d1d9;
      font-family: sans-serif;
      text-align: center;
    }
    h1 { margin-top: 20px; }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 5px;
      justify-content: center;
      margin: 20px auto;
    }
    .cell {
      width: 100px;
      height: 100px;
      background: #161b22;
      color: #fff;
      font-size: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid #30363d;
    }
    .cell:hover { background: #21262d; }
    #auth {
      margin-top: 20px;
    }
    input {
      background: #0d1117;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 5px;
      margin: 5px;
    }
    button {
      background: #238636;
      color: white;
      padding: 5px 10px;
      border: none;
      cursor: pointer;
      margin: 5px;
    }
    #stats {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ (Firebase)</h1>

  <div id="auth">
    <div id="user-form">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
      <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button onclick="login()">–í–æ–π—Ç–∏</button>
    </div>
    <div id="user-info" style="display:none;">
      üë§ <span id="user-email"></span>
      <button onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div id="stats" style="display:none;">
    <h3>–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
    –ü–æ–±–µ–¥: <span id="wins">0</span> |
    –ü–æ—Ä–∞–∂–µ–Ω–∏–π: <span id="losses">0</span>
  </div>

  <div class="board" id="board"></div>
  <p id="status"></p>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB44W1CnyyftFFxskgbhFvtCuOvBVN6Xyk",
      authDomain: "crossnull-cc1c8.firebaseapp.com",
      projectId: "crossnull-cc1c8",
      storageBucket: "crossnull-cc1c8.firebasestorage.app",
      messagingSenderId: "504007695287",
      appId: "1:504007695287:web:1e30750b9518070adfa632"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status');
    let board = ["", "", "", "", "", "", "", "", ""];
    let currentUser = null;

    function renderBoard() {
      boardEl.innerHTML = "";
      board.forEach((cell, i) => {
        const div = document.createElement('div');
        div.className = 'cell';
        div.innerText = cell;
        div.onclick = () => handleMove(i);
        boardEl.appendChild(div);
      });
    }

    function handleMove(index) {
      if (board[index] !== "" || checkWinner(board)) return;
      board[index] = "X";
      if (checkWinner(board)) {
        statusEl.innerText = "–í—ã –ø–æ–±–µ–¥–∏–ª–∏!";
        updateStats("win");
        return renderBoard();
      }
      if (board.every(cell => cell !== "")) {
        statusEl.innerText = "–ù–∏—á—å—è!";
        return renderBoard();
      }
      botMove();
      if (checkWinner(board)) {
        statusEl.innerText = "–ë–æ—Ç –ø–æ–±–µ–¥–∏–ª!";
        updateStats("loss");
      }
      renderBoard();
    }

    function botMove() {
      let move = bestMove([...board]);
      if (move !== undefined) board[move] = "O";
    }

    function bestMove(b) {
      const winPatterns = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let p of winPatterns) {
        const [a,b1,c] = p;
        if (b[a] === "O" && b[b1] === "O" && b[c] === "") return c;
        if (b[a] === "O" && b[c] === "O" && b[b1] === "") return b1;
        if (b[b1] === "O" && b[c] === "O" && b[a] === "") return a;
      }
      for (let p of winPatterns) {
        const [a,b1,c] = p;
        if (b[a] === "X" && b[b1] === "X" && b[c] === "") return c;
        if (b[a] === "X" && b[c] === "X" && b[b1] === "") return b1;
        if (b[b1] === "X" && b[c] === "X" && b[a] === "") return a;
      }
      return b.findIndex(cell => cell === "");
    }

    function checkWinner(b) {
      const winPatterns = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      return winPatterns.some(([a,b1,c]) =>
        b[a] && b[a] === b[b1] && b[a] === b[c]
      );
    }

    function resetGame() {
      board = ["", "", "", "", "", "", "", "", ""];
      statusEl.innerText = "";
      renderBoard();
    }

    async function updateStats(result) {
      if (!currentUser) return;
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      let data = snap.data();
      data.wins = data.wins || 0;
      data.losses = data.losses || 0;
      if (result === "win") data.wins += 1;
      if (result === "loss") data.losses += 1;
      await updateDoc(ref, data);
      document.getElementById("wins").innerText = data.wins;
      document.getElementById("losses").innerText = data.losses;
    }

    async function login() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
      }
    }

    async function register() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "users", cred.user.uid), {
          email: email,
          wins: 0,
          losses: 0
        });
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + e.message);
      }
    }

    async function logout() {
      await signOut(auth);
    }

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        document.getElementById("user-form").style.display = "none";
        document.getElementById("user-info").style.display = "block";
        document.getElementById("stats").style.display = "block";
        document.getElementById("user-email").innerText = user.email;
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById("wins").innerText = data.wins;
          document.getElementById("losses").innerText = data.losses;
        }
      } else {
        document.getElementById("user-form").style.display = "block";
        document.getElementById("user-info").style.display = "none";
        document.getElementById("stats").style.display = "none";
      }
      resetGame();
    });

    renderBoard();
  </script>
</body>
</html>
