<!-- ...весь твой HTML и стили остаются без изменений... -->

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB44W1CnyyftFFxskgbhFvtCuOvBVN6Xyk",
    authDomain: "crossnull-cc1c8.firebaseapp.com",
    databaseURL:
      "https://crossnull-cc1c8-default-rtdb.firebaseio.com",
    projectId: "crossnull-cc1c8",
    storageBucket: "crossnull-cc1c8.appspot.com",
    messagingSenderId: "504007695287",
    appId: "1:504007695287:web:1e30750b9518070adfa632",
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");
  const userEl = document.getElementById("user");
  const statsEl = document.getElementById("stats");
  const statsAllEl = document.getElementById("statsAll");
  const authPanel = document.getElementById("authPanel");
  const logoutBtn = document.getElementById("logoutBtn");

  let currentUser = null;

  // Инициализация игры
  const board = document.getElementById("board");
  const statusEl = document.getElementById("status");
  const newGameBtn = document.getElementById("newGameBtn");

  let cells = Array(9).fill(null);
  let playerTurn = true;
  let gameOver = false;

  function checkWinner(bd, sym) {
    const winCombos = [
      [0, 1, 2],
      [3, 4, 5],
      [6, 7, 8],
      [0, 3, 6],
      [1, 4, 7],
      [2, 5, 8],
      [0, 4, 8],
      [2, 4, 6],
    ];
    return winCombos.some((combo) => combo.every((i) => bd[i] === sym));
  }

  // Обновлённая функция бота — ходит, чтобы никогда не проиграть
  function botMove() {
    if (gameOver) return -1;

    // 1. Ход для победы
    for (let i = 0; i < 9; i++) {
      if (!cells[i]) {
        let testCells = [...cells];
        testCells[i] = "O";
        if (checkWinner(testCells, "O")) {
          cells[i] = "O";
          return i;
        }
      }
    }

    // 2. Блокировка хода игрока
    for (let i = 0; i < 9; i++) {
      if (!cells[i]) {
        let testCells = [...cells];
        testCells[i] = "X";
        if (checkWinner(testCells, "X")) {
          cells[i] = "O";
          return i;
        }
      }
    }

    // 3. Центр
    if (!cells[4]) {
      cells[4] = "O";
      return 4;
    }

    // 4. Углы
    const corners = [0, 2, 6, 8];
    for (const i of corners) {
      if (!cells[i]) {
        cells[i] = "O";
        return i;
      }
    }

    // 5. Остальные клетки
    for (let i = 0; i < 9; i++) {
      if (!cells[i]) {
        cells[i] = "O";
        return i;
      }
    }

    return -1;
  }

  function renderBoard() {
    board.innerHTML = "";
    for (let i = 0; i < 9; i++) {
      const div = document.createElement("div");
      div.className = "cell";
      div.innerText = cells[i] || "";
      div.addEventListener("click", () => {
        if (gameOver || !playerTurn || cells[i]) return;
        cells[i] = "X";
        playerTurn = false;
        renderBoard();

        if (checkWinner(cells, "X")) {
          setStatus("Вы выиграли!");
          gameOver = true;
          updateUserStats("wins");
          updateGlobalStats("wins");
          return;
        }

        if (!cells.includes(null)) {
          setStatus("Ничья");
          gameOver = true;
          updateUserStats("draws");
          updateGlobalStats("draws");
          return;
        }

        const botIndex = botMove();
        renderBoard();

        if (checkWinner(cells, "O")) {
          setStatus("Бот победил!");
          gameOver = true;
          updateUserStats("losses");
          updateGlobalStats("losses");
          return;
        }

        if (!cells.includes(null)) {
          setStatus("Ничья");
          gameOver = true;
          updateUserStats("draws");
          updateGlobalStats("draws");
          return;
        }

        playerTurn = true;
        setStatus("Ваш ход");
      });
      board.appendChild(div);
    }
  }

  function setStatus(text) {
    statusEl.textContent = text;
  }

  function resetGame() {
    cells.fill(null);
    playerTurn = true;
    gameOver = false;
    setStatus("Ваш ход");
    renderBoard();
  }

  newGameBtn.addEventListener("click", () => {
    resetGame();
  });

  // Работа с Firebase статистикой

  function updateUserStats(field) {
    if (!currentUser) return;
    const statsRef = db.ref("users/" + currentUser.uid + "/stats");
    statsRef.transaction((stats) => {
      if (stats == null) {
        stats = { wins: 0, losses: 0, draws: 0 };
      }
      stats[field] = (stats[field] || 0) + 1;
      return stats;
    });
  }

  function updateGlobalStats(field) {
    const globalRef = db.ref("globalStats");
    globalRef.transaction((stats) => {
      if (stats == null) {
        stats = { wins: 0, losses: 0, draws: 0 };
      }
      stats[field] = (stats[field] || 0) + 1;
      return stats;
    });
  }

  function displayStats(userStats, globalStats) {
    if (userStats) {
      statsEl.innerHTML = `<br>
        Побед: ${userStats.wins || 0}<br>
        Поражений: ${userStats.losses || 0}<br>
        Ничьих: ${userStats.draws || 0}`;
    } else {
      statsEl.innerHTML = `<br>Нет данных`;
    }
    if (globalStats) {
      statsAllEl.innerHTML = `<br>
        Побед: ${globalStats.wins || 0}<br>
        Поражений: ${globalStats.losses || 0}<br>
        Ничьих: ${globalStats.draws || 0}`;
    } else {
      statsAllEl.innerHTML = `<br>Нет данных`;
    }
  }

  function listenStats(uid) {
    if (!uid) {
      displayStats(null, null);
      return;
    }
    const userStatsRef = db.ref("users/" + uid + "/stats");
    const globalStatsRef = db.ref("globalStats");

    userStatsRef.on("value", (snapshot) => {
      const userStats = snapshot.val();
      db.ref("globalStats").once("value").then((snap) => {
        displayStats(userStats, snap.val());
      });
    });

    globalStatsRef.on("value", (snapshot) => {
      const globalStats = snapshot.val();
      db.ref("users/" + uid + "/stats").once("value").then((snap) => {
        displayStats(snap.val(), globalStats);
      });
    });
  }

  // Аутентификация

  function updateUI(user) {
    if (user) {
      currentUser = user;
      userEl.textContent = user.email;
      authPanel.style.display = "none";
      logoutBtn.style.display = "block";
      listenStats(user.uid);
    } else {
      currentUser = null;
      userEl.textContent = "";
      authPanel.style.display = "flex";
      logoutBtn.style.display = "none";
      displayStats(null, null);
    }
  }

  auth.onAuthStateChanged((user) => {
    updateUI(user);
    resetGame();
  });

  document.getElementById("registerBtn").addEventListener("click", () => {
    const email = emailEl.value.trim();
    const password = passwordEl.value;
    if (!email || !password) {
      alert("Введите email и пароль");
      return;
    }
    auth
      .createUserWithEmailAndPassword(email, password)
      .then(() => alert("Регистрация успешна"))
      .catch((e) => alert("Ошибка: " + e.message));
  });

  document.getElementById("loginBtn").addEventListener("click", () => {
    const email = emailEl.value.trim();
    const password = passwordEl.value;
    if (!email || !password) {
      alert("Введите email и пароль");
      return;
    }
    auth
      .signInWithEmailAndPassword(email, password)
      .catch((e) => alert("Ошибка: " + e.message));
  });

  logoutBtn.addEventListener("click", () => {
    auth.signOut();
  });

  // Запуск
  resetGame();
</script>
